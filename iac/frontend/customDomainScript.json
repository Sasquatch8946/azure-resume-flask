{
    "type": "Microsoft.Resources/deploymentScripts",
    "name": "query",
    "apiVersion": "2020-10-01",
    "kind": "AzurePowerShell",
    "location": "[resourceGroup().location]",
    "properties": {
        "cleanupPreference": "Always",
        "retentionInterval": "PT1H",
        "azPowerShellVersion": "6.0",
        "environmentVariables": [
            {
                "name": "AUTH_TOKEN",
                "secureValue": "[parameters('token')]"
            }
        ],
        "arguments": "[concat('-account ', parameters('account'), ' -subId ', subscription().subscriptionId, ' -resourceGroup ', resourceGroup().name, ' -profileName ', parameters('profileName'), ' -domainName ', variables('domainName'))]",
        "scriptContent": "
            param([string] $account, [string] $subId, [string] $resourceGroup, [string] $profileName, [string] $domainName)
            $authToken = $env:AUTH_TOKEN
            Start-Sleep -Seconds 60
            Connect-AzAccount -AccessToken \"$($authToken)\" -AccountId $account -Subscription $subId
            $valToken = (ConvertFrom-Json (Invoke-AzRestMethod -Method get -Path \"/subscriptions/$($subId)/resourceGroups/$($resourceGroup)/providers/Microsoft.Cdn/profiles/$($profileName)/customDomains/$($domainName)?api-version=2020-09-01\").content).properties.validationProperties.validationToken
            $DeploymentScriptOutputs = @{}
            $DeploymentScriptOutputs['validationToken'] = $valToken
        "
    }
}

